package projects.weatherforecaster;

import androidx.appcompat.app.AppCompatActivity;

import android.annotation.SuppressLint;
import android.os.AsyncTask;
import android.os.Bundle;
import android.view.View;
import android.widget.TextView;

import org.json.JSONObject;

import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;
import java.util.Scanner;

public class MainActivity extends AppCompatActivity {

    public String city = "cairns,au";
    public String api = "15c50ca47bb11c7c3e7f90582de67a37";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        new getWeather().execute();
    }

    public class getWeather extends AsyncTask<String, Void, String> {

        @Override
        protected void onPreExecute() {
            super.onPreExecute();

            findViewById(R.id.loader).setVisibility(View.VISIBLE);
            findViewById(R.id.location).setVisibility(View.GONE);
            findViewById(R.id.updated_location).setVisibility(View.GONE);
            findViewById(R.id.status).setVisibility(View.GONE);
            findViewById(R.id.temperature).setVisibility(View.GONE);
            findViewById(R.id.min_temp).setVisibility(View.GONE);
            findViewById(R.id.max_temp).setVisibility(View.GONE);
            findViewById(R.id.container_sunrise).setVisibility(View.GONE);
            findViewById(R.id.container_sunset).setVisibility(View.GONE);
            findViewById(R.id.container_wind).setVisibility(View.GONE);
            findViewById(R.id.container_pressure).setVisibility(View.GONE);
            findViewById(R.id.container_humidity).setVisibility(View.GONE);
            findViewById(R.id.container_info).setVisibility(View.GONE);
            findViewById(R.id.error).setVisibility(View.GONE);
        }


        @Override
        protected String doInBackground(String... strings) {
            URL link;
            Scanner sc;
            String result;
            try {

                link = new URL("https://api.openweathermap.org/data/2.5/weather?q=cairns,au&unit=metric&appid=15c50ca47bb11c7c3e7f90582de67a37");
                sc = new Scanner(link.openStream());
                StringBuilder sb = new StringBuilder();
                while(sc.hasNext()) {
                    sb.append(sc.next());
                }
                result = sb.toString();
            }   catch (Exception e) {
                result = null;
            }
            return result;
        }

        @Override
        protected void onPostExecute(String result) {
            super.onPostExecute(result);
            try {
                JSONObject jsonObject = new JSONObject(result);
                JSONObject main = jsonObject.getJSONObject("main");
                JSONObject sys = jsonObject.getJSONObject("sys");
                JSONObject wind = jsonObject.getJSONObject("wind");
                JSONObject weather = jsonObject.getJSONArray("weather").getJSONObject(0);
                long updatedAt = jsonObject.getLong("dt");
                String pattern = "dd/MM/yyyy hh:mm a";
                SimpleDateFormat simpleDateFormat = new SimpleDateFormat(pattern, Locale.ENGLISH);
                String updatedAtText = "Updated at: " + simpleDateFormat.format(new Date(updatedAt*1000));
                String temp = main.getString("temp") + "°C";
                String tempMin = "Min Temp: " + main.getString("temp_min") + "°C";
                String tempMax = "Max Temp: " + main.getString("temp_max") + "°C";
                String pressure_val = main.getString("pressure");
                String humidity_val = main.getString("humidity");
                long sunrise_val = sys.getLong("sunrise");
                long sunset_val = sys.getLong("sunset");
                String windSpeed = wind.getString("speed");
                String weatherDescription = weather.getString("description");
                String address = jsonObject.getString("name") + ", " + sys.getString("country");

                TextView location = (TextView) findViewById(R.id.location);
                TextView updated_at = (TextView) findViewById(R.id.updated_location);
                TextView status = (TextView) findViewById(R.id.status);
                TextView temperature = (TextView) findViewById(R.id.temperature);
                TextView temp_min = (TextView) findViewById(R.id.min_temp);
                TextView temp_max = (TextView) findViewById(R.id.max_temp);
                TextView sunrise = (TextView) findViewById(R.id.sunrise);
                TextView sunset = (TextView) findViewById(R.id.sunset);
                TextView windView = (TextView) findViewById(R.id.wind);
                TextView pressure = (TextView) findViewById(R.id.pressure);
                TextView humidity = (TextView) findViewById(R.id.humidity);

                location.setText(address);
                updated_at.setText(updatedAtText);
                weatherDescription = weatherDescription.substring(0,1).toUpperCase() + weatherDescription.substring(1).toLowerCase();
                status.setText(weatherDescription);
                temperature.setText(temp);
                temp_min.setText(tempMin);
                temp_max.setText(tempMax);
                sunrise.setText(simpleDateFormat.format(new Date(sunrise_val*1000)));
                sunset.setText(simpleDateFormat.format(new Date(sunset_val*1000)));
                pressure.setText(pressure_val);
                humidity.setText(humidity_val);
                windView.setText(windSpeed);

                findViewById(R.id.loader).setVisibility(View.GONE);
                findViewById(R.id.updated_location).setVisibility(View.VISIBLE);
                findViewById(R.id.status).setVisibility(View.VISIBLE);
                findViewById(R.id.temperature).setVisibility(View.VISIBLE);
                findViewById(R.id.min_temp).setVisibility(View.VISIBLE);
                findViewById(R.id.max_temp).setVisibility(View.VISIBLE);
                findViewById(R.id.container_sunrise).setVisibility(View.VISIBLE);
                findViewById(R.id.container_sunset).setVisibility(View.VISIBLE);
                findViewById(R.id.container_wind).setVisibility(View.VISIBLE);
                findViewById(R.id.container_pressure).setVisibility(View.VISIBLE);
                findViewById(R.id.container_humidity).setVisibility(View.VISIBLE);
                findViewById(R.id.container_info).setVisibility(View.VISIBLE);
            }
            catch (Exception e) {
                findViewById(R.id.loader).setVisibility(View.GONE);
                findViewById(R.id.error).setVisibility(View.VISIBLE);
            }
        }

    }
}